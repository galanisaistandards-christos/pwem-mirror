name: Deploy static site to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure Pages
        uses: actions/configure-pages@v5

      # Î‘Î½ÎµÎ²Î¬Î¶Î¿Ï…Î¼Îµ ÎŸÎ›ÎŸ Ï„Î¿ repo Ï‰Ï‚ artifact (ÏÏƒÏ„Îµ Î½Î± ÏƒÎµÏÎ²Î¯ÏÎµÏ„Î±Î¹ ÏŒÎ»Î¿ Ï„Î¿ /memory/**)
      - name: Upload site artifact (entire repo)
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # Smoke-check: ÎµÎ»Î­Î³Ï‡Î¿Ï…Î¼Îµ 3-4 ÎºÏÎ¯ÏƒÎ¹Î¼Î± URLs Î¼Îµ retry
      - name: Smoke-check key URLs (200 + Î±Î½Î±Î¼ÎµÎ½ÏŒÎ¼ÎµÎ½Î¿ body ÏŒÏ€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹)
        shell: bash
        env:
          BASE_URL: ${{ steps.deployment.outputs.page_url }}
        run: |
          set -euo pipefail

          base="${BASE_URL%/}"
          echo "Base URL: $base"

          # Î›Î¯ÏƒÏ„Î± ÎµÎ»Î­Î³Ï‡Ï‰Î½: "relative_path|||optional_expected_substring"
          checks=(
            "memory/chron/2025/ping.txt|||ok"
            "memory/chron/2025/index.html|||"
            "memory/chron/2025/01/index.html|||"
            "memory/chron/2025/08/index.html|||"
          )

          # poll Î¼Îµ retries (40 x 3s â‰ˆ 2 Î»ÎµÏ€Ï„Î¬)
          poll() {
            local url="$1"
            local expect="${2:-}"
            for i in $(seq 1 40); do
              # Î Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ status code
              code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              # ÎšÎ±Î¹ Î±Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÎºÎ±Î¹ Ï„Î¿ body
              body=""
              if [[ -n "$expect" ]]; then
                body=$(curl -s "$url" || true)
              fi

              if [[ "$code" == "200" ]]; then
                if [[ -z "$expect" || "$body" == *"$expect"* ]]; then
                  echo "âœ… OK: $url"
                  return 0
                fi
              fi
              echo "â³ Attempt $i: code=$code (expecting 200) ${expect:+and body contains '$expect'}"
              sleep 3
            done
            echo "âŒ FAIL: $url"
            return 1
          }

          failed=0
          for item in "${checks[@]}"; do
            rel="${item%%|||*}"
            exp="${item#*|||}"
            url="$base/$rel"
            if ! poll "$url" "$exp"; then
              failed=1
            fi
          done

          if [[ "$failed" -ne 0 ]]; then
            echo "âŒ Smoke-check failed"; exit 1
          else
            echo "ğŸ‰ Smoke-check passed"
          fi
