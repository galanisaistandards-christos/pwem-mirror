name: Deploy static site to Pages

on:
  push:
    branches: [main]
    paths:
      - 'memory/**'
      - 'assets/**'
      - 'index.html'
      - '.github/workflows/pages.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Î¦Ï„Î¹Î¬Ï‡Î½Î¿Ï…Î¼Îµ ÏÎ·Ï„Î¬ Î­Î½Î±Î½ Ï†Î¬ÎºÎµÎ»Î¿ site/ Î¼Îµ ÏŒ,Ï„Î¹ Î¸Î­Î»Î¿Ï…Î¼Îµ Î½Î± Î´Î·Î¼Î¿ÏƒÎ¹ÎµÏ…Ï„ÎµÎ¯
      - name: Build site directory (memory + assets)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf site
          mkdir -p site
          rsync -a --delete memory/ site/memory/
          rsync -a --delete assets/ site/assets/ || true
          [ -f index.html ] && cp -a index.html site/ || true
          touch site/.nojekyll
          echo "Site preview:"
          find site -type f | sort | head -60

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
          if-no-files-found: error

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # Smoke-check Î¼ÎµÏ„Î¬ Ï„Î¿ deploy (Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ Î¼Î­Ï‡ÏÎ¹ Î½Î± Î²Î³ÎµÎ¹ live)
      - name: Smoke-check (ping, heartbeat, status, month index)
        env:
          BASE_URL: ${{ steps.deployment.outputs.page_url }}
        shell: bash
        run: |
          set -euo pipefail

          poll() {
            local url="$1"
            local expect="${2:-}"
            for i in $(seq 1 40); do
              code=$(curl -s -o /dev/null -w "%{http_code}" "$url" || true)
              body=""
              if [[ -n "$expect" ]]; then body=$(curl -s "$url" || true); fi
              if [[ "$code" == "200" ]] && { [[ -z "$expect" ]] || [[ "$body" == *"$expect"* ]]; }; then
                echo "âœ… $url"
                return 0
              fi
              echo "â³ try $i: $code â€¦"; sleep 3
            done
            echo "âŒ FAIL $url"; return 1
          }

          base="${BASE_URL%/}"
          echo "ğŸ‘ Smoke @ $(date -u +"%Y-%m-%d %H:%M:%S UTC") â€” $base"

          poll "$base/memory/ping.txt" "ok"
          poll "$base/memory/heartbeat.json" "\"ok\": true"
          poll "$base/memory/status.json" "\"ok\": true"
          # ÎšÏÎ¯ÏƒÎ¹Î¼Î¿: Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ±Î¹ Î¿ Î¼Î®Î½Î±Ï‚
          poll "$base/memory/chron/2025/01/index.html" "<html"
