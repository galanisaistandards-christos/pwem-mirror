name: Deploy static site to Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Pages
        uses: actions/configure-pages@v5

      # ---------- STAGE SITE ----------
      - name: Stage site (full copy + .nojekyll)
        id: stage
        shell: bash
        run: |
          set -euo pipefail
          site="site"
          rm -rf "$site"
          mkdir -p "$site"

          # index & assets (Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½)
          if [[ -f "index.html" ]]; then
            cp -a index.html "$site/"
          fi
          if [[ -d assets ]]; then
            mkdir -p "$site/assets"
            cp -a assets/. "$site/assets/"
          fi

          # === Î— Î”Î™ÎŸÎ¡Î˜Î©Î£Î—: Î‘ÎÎ‘Î”Î¡ÎŸÎœÎ™ÎšÎ— Î‘ÎÎ¤Î™Î“Î¡Î‘Î¦Î— ÎŸÎ›ÎŸÎ¥ Î¤ÎŸÎ¥ memory/ ===
          # ÎœÎ—Î Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ 'memory/**' (Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ recursive Ï‡Ï‰ÏÎ¯Ï‚ globstar).
          if [[ -d memory ]]; then
            mkdir -p "$site/memory"
            cp -a memory/. "$site/memory/"
          fi

          # Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯ Jekyll processing
          touch "$site/.nojekyll"

          echo "ğŸ“¦ Staged site to '$site'"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # ---------- SMOKE CHECK ----------
      - name: Smoke-check (multi URL)
        shell: bash
        env:
          BASE_URL: ${{ steps.deployment.outputs.page_url }}
          ATTEMPT: ${{ github.run_number }}
        run: |
          set -euo pipefail

          when="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          # Î”Ï…Î½Î±Î¼Î¹ÎºÎ¬ Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¬ÏÎ¹ÎºÎ± emoji: Ï„ÏŒÏƒÎ± ğŸ‘ ÏŒÏƒÎ± Ï„Î¿ attempt
          peachs=$(printf 'ğŸ‘%.0s' $(seq 1 "$ATTEMPT"))

          echo "ğŸŒ€ Smoke attempt #${ATTEMPT} â€” ${when} ${peachs}"

          http_code() { curl -sS -o /dev/null -w "%{http_code}" "$1"; }
          body_of()  { curl -sS "$1" || true; }

          poll() {
            local url="$1"
            local expect="${2-}"       # optional substring Ï€Î¿Ï… Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ„Î¿ body

            for i in $(seq 1 40); do   # ~2 Î»ÎµÏ€Ï„Î¬
              code="$(http_code "$url")"
              if [[ "$code" == "200" ]]; then
                if [[ -z "$expect" ]] || body="$(body_of "$url")" && [[ "$body" == *"$expect"* ]]; then
                  echo "âœ… OK: $url"
                  return 0
                fi
              fi
              echo "â³ try $i: code=$code (want 200)${expect:+; expect body contains '$expect'}"
              sleep 3
            done

            echo "âŒ FAIL: $url"
            return 1
          }

          base="${BASE_URL%/}"

          # URLs Ï€Î¿Ï… ÎµÎ»Î­Î³Ï‡Î¿Ï…Î¼Îµ
          declare -a checks=(
            "Ping|ok|$base/memory/ping.txt"
            "Heartbeat|\"ok\": true|$base/memory/heartbeat.json"
            "Status|\"ok\": true|$base/memory/status.json"
            "Chron-2025 index|PWEM|$base/memory/chron/2025/index.html"
            "Chron-2025-01 index|PWEM|$base/memory/chron/2025/01/index.html"
          )

          failed=0
          for row in "${checks[@]}"; do
            IFS='|' read -r rel expect url <<<"$row"
            echo "ğŸ” $rel â†’ $url"
            if ! poll "$url" "$expect"; then
              failed=1
            fi
          done

          if [[ "$failed" -ne 0 ]]; then
            echo "ğŸ’¥ Smoke-check failed"
            exit 1
          else
            echo "ğŸ‰ Smoke-check passed"
          fi
