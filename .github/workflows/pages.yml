name: Deploy static site to Pages

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/pages.yml'
      - 'index.html'
      - 'assets/**'
      - 'memory/**'
      - '.nojekyll'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'github-pages'
  cancel-in-progress: true

jobs:
  build:
    name: Build artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Î£Ï„Î®Î½Î¿Ï…Î¼Îµ Î¤ÎŸ Î Î‘ÎÎ¤Î‘ ÏƒÎµ site/ Î³Î¹Î± Î±Î½Î­Î²Î±ÏƒÎ¼Î± ÏƒÏ„Î¿ Pages (memory + assets + .nojekyll)
      - name: Stage site/ (memory + assets + .nojekyll)
        run: |
          set -euo pipefail
          rm -rf site
          mkdir -p site
          # Î Î¬ÏÎµ Î¿Î»ÏŒÎºÎ»Î·ÏÎ¿ Ï„Î¿Î½ Ï†Î¬ÎºÎµÎ»Î¿ memory/ (ÎºÎ±Î¹ Ï„Î± chron/2025/01/index.html ÎºÏ„Î»)
          rsync -av --delete memory/ site/memory/
          # Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ assets/
          if [ -d assets ]; then rsync -av --delete assets/ site/assets/; fi
          # .nojekyll Î³Î¹Î± Î½Î± ÏƒÎµÏÎ²Î¯ÏÎµÏ„Î±Î¹ ÎŸ,Î¤Î™ Î¥Î Î‘Î¡Î§Î•Î™ ÏŒÏ€Ï‰Ï‚ ÎµÎ¯Î½Î±Î¹
          cp -f .nojekyll site/.nojekyll 2>/dev/null || true
          echo "----- Listing (<=3 ÎµÏ€Î¯Ï€ÎµÎ´Î±) -----"
          find site -maxdepth 3 -type f | sort

      - name: Upload artifact to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4

  smoke:
    name: Smoke-check after deploy (multi URL)
    runs-on: ubuntu-latest
    needs: deploy
    env:
      BASE_URL: ${{ needs.deploy.outputs.page_url }}
    steps:
      - name: Poll URLs until 200 (+optional body match)
        shell: bash
        run: |
          set -euo pipefail

          base="${BASE_URL%/}/"   # ÎµÎ¾Î¿Î¼Î¬Î»Ï…Î½ÏƒÎ·

          # helper: ÎµÏ€Î±Î½Î±Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ ðŸ‘ ÏŒÏƒÎµÏ‚ Ï†Î¿ÏÎ­Ï‚ Ï€ÎµÎ¹Ï‚ (Î³Î¹Î± ÎºÎ­Ï†Î¹ ÏƒÏ„Î± logs)
          peaches() { n=${1:-1}; for i in $(seq 1 "$n"); do printf 'ðŸ‘'; done; }

          # helper: poll Î¼Îµ retries (40 x 3s ~ 2 Î»ÎµÏ€Ï„Î¬)
          poll() {
            local url="$1"
            local expect="${2-}"  # Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ substring ÏƒÏ„Î¿ body

            for i in $(seq 1 40); do
              when="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
              echo "::group::Attempt #$i â€” $when $(peaches "$i")"
              code="$(curl -s -o /dev/null -w "%{http_code}" "$url")"
              body=""
              if [ -n "$expect" ]; then
                body="$(curl -s "$url" || true)"
              fi

              if [ "$code" = "200" ] && { [ -z "$expect" ] || [[ "$body" == *"$expect"* ]]; }; then
                echo "âœ… 200 OK â€” $url"
                echo "::endgroup::"
                return 0
              fi

              echo "â³ code=$code (need 200) expect='${expect}'"
              echo "::endgroup::"
              sleep 3
            done

            echo "âŒ FAIL â€” $url"
            return 1
          }

          # URLs Ï€ÏÎ¿Ï‚ Î­Î»ÎµÎ³Ï‡Î¿ (rel|optional-expected-substring)
          checks=(
            "memory/ping.txt|ok"
            "memory/heartbeat.json|\"ok\": true"
            "memory/status.json|\"ok\": true"
            "memory/chron/2025/index.html|"
            "memory/chron/2025/01/index.html|"
          )

          failed=0
          for item in "${checks[@]}"; do
            rel="${item%%|*}"
            exp="${item#*|}"
            url="${base}${rel}"
            if ! poll "$url" "$exp"; then
              failed=1
            fi
          done

          if [ "$failed" -ne 0 ]; then
            echo "ðŸ§¯ Smoke-check failed"
            exit 1
          fi

          echo "ðŸŸ¢ Smoke-check passed"
