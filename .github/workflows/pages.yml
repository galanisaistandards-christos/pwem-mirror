name: Deploy static site to Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      # Î‘Î½ÎµÎ²Î¬Î¶Î¿Ï…Î¼Îµ ÎŸÎ›ÎŸ Ï„Î¿ repo ÏƒÎ±Î½ artifact (ÏƒÎµÏÎ²Î¯ÏÎµÏ„Î±Î¹ Ï‰Ï‚ static)
      - name: Upload full repo to GitHub Pages (artifact path ".")
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    name: Deploy + Smoke-check
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # -------------------------------
      # ğŸ”¥ Smoke-check Î¼ÎµÏ„Î¬ Ï„Î¿ deploy
      # -------------------------------
      - name: Smoke-check (multi URL: ping(s) + index) ğŸ§
        shell: bash
        env:
          BASE_URL: ${{ steps.deployment.outputs.page_url }}
        run: |
          set -euo pipefail

          # Î•ÎºÏ„Ï…Ï€ÏÎ½Î¿Ï…Î¼Îµ Â«ÏƒÎºÏ…Ï„Î¬Î»Î·Â»: attempt, ÏÏÎ±, emojis
          attempt="#06"   # <â€” Î‘Î¥ÎÎ‘ÎÎ•Î™Î£ ÏƒÎµ ÎºÎ¬Î¸Îµ Î±Î»Î»Î±Î³Î® (Î³Î¹Î± Î¿ÏÎ±Ï„Î® Î¹Ï‡Î½Î·Î»Î¬Ï„Î·ÏƒÎ·) 
          when="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸš€ Smoke attempt ${attempt} @ ${when}"

          # ÎœÎ¹ÎºÏÏŒ helper: GET Î¼ÏŒÎ½Î¿ status code
          http_code() { curl -s -o /dev/null -w "%{http_code}" "$1"; }

          # poll Î¼Îµ retries (40 x 3s â‰ˆ 2 Î»ÎµÏ€Ï„Î¬)
          poll() {
            local url="$1"
            local expect="${2:-}"
            for i in $(seq 1 40); do
              code="$(http_code "$url")"
              body=""
              if [[ -n "$expect" ]]; then
                body="$(curl -s "$url" || true)"
              fi
              if [[ "$code" == "200" ]]; then
                if [[ -z "$expect" || "$body" == *"$expect"* ]]; then
                  echo "âœ… OK: $url"
                  return 0
                fi
              fi
              echo "â³ Attempt $i: code=$code (expecting 200) ${expect:+and body contains '$expect'}"
              sleep 3
            done
            echo "âŒ FAIL: $url"
            return 1
          }

          # ğŸ‘ Î”Ï…Î½Î±Î¼Î¹ÎºÎ¬ ÏÎ¿Î´Î±ÎºÎ¹Î½Î¬ÎºÎ¹Î± = Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±Ï‚ (strip Ï„Î¿ #)
          repeat_peaches(){ n="$1"; out=""; for _ in $(seq 1 "$n"); do out="$outğŸ‘"; done; printf '%s' "$out"; }
          att_no="${attempt#\#}"
          echo "ğŸ‘ $(repeat_peaches "$att_no")"

          # URLs & (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ) expected body substring
          checks=(
            "memory/chron/2025/ping.txt|ok"
            "memory/ping.txt|ok"
            "memory/heartbeat.json|\"ok\""  # Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ "ok"
            "memory/status.json|\"ok\""     # Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ "ok"
            "memory/chron/2025/index.html|"
            "index.html|"
          )

          failed=0
          for item in "${checks[@]}"; do
            rel="${item%%|*}"
            exp="${item#*|}"
            url="${BASE_URL%/}/$rel"
            if ! poll "$url" "$exp"; then
              failed=1
            fi
          done

          if [[ "$failed" -ne 0 ]]; then
            echo "ğŸ’¥ Smoke-check failed"
            exit 1
          else
            echo "ğŸ‰ Smoke-check passed"
          fi
