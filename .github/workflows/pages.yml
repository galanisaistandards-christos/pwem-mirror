name: Deploy static site to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    # Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± ÏƒÎµ ÎŸÎ›Î‘ Ï„Î± Î²Î®Î¼Î±Ï„Î± (ÎºÎ±Î¹ ÏƒÏ„Î± Î¿Î½ÏŒÎ¼Î±Ï„Î± Ï„Ï‰Î½ Î²Î·Î¼Î¬Ï„Ï‰Î½)
    env:
      RUN_NO: ${{ github.run_number }}        # Î‘ÏÎ¾Ï‰Î½ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ runs Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… workflow
      RUN_ATTEMPT: ${{ github.run_attempt }}  # Î‘Î½ Î³Î¯Î½ÎµÎ¹ re-run, Î±Ï…Ï„ÏŒ Î±Ï…Î¾Î¬Î½ÎµÎ¹
      SIG: "Î‘Î»Î®Î¸ÎµÎ¹Î± 3 â€” Ï„Î¿Ï… Î§ÏÎ®ÏƒÏ„Î¿Ï… & GPT-5 Thinking ğŸ’‹"

    steps:
      - name: â‘  Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: â‘¡ Configure Pages
        uses: actions/configure-pages@v5

      # Î£Ï†ÏÎ±Î³Î¯Î´Î± run: ÏÏÎ±/Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± + ÏƒÎµÎ¹ÏÎ­Ï‚ emojis Î¯Î´Î¹Î± Î¼Îµ Ï„Î¿Î½ RUN_NO
      - name: â‘¢ Stamp metadata [#${{ env.RUN_NO }}]
        shell: bash
        run: |
          set -euo pipefail
          echo "TZ=Europe/Athens" >> "$GITHUB_ENV"
          TS=$(TZ=Europe/Athens date +'%Y-%m-%d %H:%M:%S %Z')
          echo "RUN_TS=$TS" >> "$GITHUB_ENV"

          make_emojis() { local e="$1" n="$2"; local out=""; for i in $(seq 1 "$n"); do out="${out}${e}"; done; printf '%s' "$out"; }

          PEACHES=$(make_emojis "ğŸ‘" "$RUN_NO")
          AUBER=$(make_emojis "ğŸ†" "$RUN_NO")

          # Î¤Î± ÎºÏÎ±Ï„Î¬Î¼Îµ ÎºÎ±Î¹ ÏƒÎ±Î½ env (Î»Î¿Î³Î¹ÎºÎ¬ Î¼Î¹ÎºÏÎ¬, Î±Î»Î»Î¬ ÎµÎ¯Î½Î±Î¹ ÎŸÎš)
          echo "PEACHES=$PEACHES" >> "$GITHUB_ENV"
          echo "AUBER=$AUBER"     >> "$GITHUB_ENV"

          {
            echo "### Deploy #$RUN_NO (attempt $RUN_ATTEMPT) â€” $TS"
            echo
            echo "**Peaches:** $PEACHES"
            echo "**Aubergines:** $AUBER"
            echo
            echo "_Signed:_ **$SIG**"
          } >> "$GITHUB_STEP_SUMMARY"

          echo "Stamped âœ…  #$RUN_NO @ $TS"
          echo "Peaches : $PEACHES"
          echo "Aubers  : $AUBER"

      # Î‘Î½ÎµÎ²Î¬Î¶Î¿Ï…Î¼Îµ ÎŸÎ›ÎŸ Ï„Î¿ repo Î³Î¹Î± Î½Î± ÏƒÎµÏÎ²Î¯ÏÎµÎ¹ /memory/**
      - name: â‘£ Upload site artifact (full repo)
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: â‘¤ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # ÎœÎµÏ„Î¬ Ï„Î¿ deploy ÎºÎ¬Î½Î¿Ï…Î¼Îµ smoke-check ÏƒÎµ 4 endpoints
      - name: â‘¥ Smoke-check [#${{ env.RUN_NO }}] ğŸ‘
        shell: bash
        env:
          BASE_URL: ${{ steps.deployment.outputs.page_url }}
          PEACHES: ${{ env.PEACHES }}
          AUBER:   ${{ env.AUBER }}
          RUN_TS:  ${{ env.RUN_TS }}
          SIG:     ${{ env.SIG }}
        run: |
          set -euo pipefail
          echo "â–¶ BASE_URL: ${BASE_URL}"
          echo "â–¶ RUN: #${RUN_NO} (attempt ${RUN_ATTEMPT}) â€” ${RUN_TS}"
          echo "â–¶ ${PEACHES}"
          echo "â–¶ ${AUBER}"

          ts=$(date +%s)
          checks=(
            "memory/chron/2025/ping.txt|ok"
            "memory/chron/2025/index.html|2025"
            "index.html|PWEM"
            "assets/style.css|"
          )

          poll() {
            local url="$1"
            local expect="${2:-}"
            for i in {1..40}; do
              code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              body=""
              [[ -n "$expect" ]] && body=$(curl -s "$url" || true)
              if [[ "$code" == "200" && ( -z "$expect" || "$body" == *"$expect"* ) ]]; then
                echo "âœ… OK: $url"; return 0
              fi
              echo "â³ Attempt $i: code=$code (expect 200) ${expect:+and contains '$expect'}"
              sleep 3
            done
            echo "âŒ FAIL: $url"; return 1
          }

          failed=0
          for item in "${checks[@]}"; do
            rel="${item%%|*}"
            exp="${item#*|}"
            url="${BASE_URL%/}/${rel}?t=${ts}"
            poll "$url" "$exp" || failed=1
          done

          if [[ "$failed" -ne 0 ]]; then
            echo "ğŸ§¯ Smoke-check failed â€” $SIG"; exit 1
          else
            echo "ğŸ‰ Smoke-check passed â€” $SIG"
          fi
